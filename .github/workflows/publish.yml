name: Publish to crates.io

on:
  push:
    tags:
      - "kuiper-*-v*"

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Determine crate from tag
        id: crate
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG##*-v}"
          CRATE_NAME="${TAG%-v*}"
          echo "name=${CRATE_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Verify version matches Cargo.toml
        run: |
          CARGO_VERSION=$(cargo metadata --no-deps --format-version 1 | \
            jq -r --arg name "${{ steps.crate.outputs.name }}" \
            '.packages[] | select(.name == $name) | .version')
          if [[ "$CARGO_VERSION" != "${{ steps.crate.outputs.version }}" ]]; then
            echo "::error::Tag version (${{ steps.crate.outputs.version }}) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

      - name: Publish
        run: cargo publish --package ${{ steps.crate.outputs.name }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
